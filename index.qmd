---
echo: false
toc: false
title-block-style: none
---

```{ojs}
APIroot = "https://specif-dsn.lab.sspcloud.fr"
```


```{ojs}
liste_codes = d3.json(`${APIroot}/liste_rubriques?annee=${annee}`)
```


::: {.column-page}

# API d'extraction d'infos de la DSN

Une extraction bête et méchante du contenu du manuel technique 2025 de la DSN, un magnifique PDF de 400 pages. 


:::: {.callout-tip collapse="true"}
## Bientôt

* De l'IA sur les titres de rubriques et description pour rendre la recherche plus intelligente.
* Choix des années

::::


```{ojs}
viewof annee = Inputs.radio(
  ["2022", "2023", "2024", "2025"],
  {label: "Année", value: "2025"}
)
```



```{ojs}
viewof codeDSN = Inputs.text({
  label: "Code technique DSN",
  placeholder: "Entrer un code avec l'aide de l'autocomplétion",
  value: liste_codes['codes'][0],
  datalist: liste_codes['codes']
})
```

<br>

```{ojs}
urlCahierTechnique = d3.json(
  `${APIroot}/cahier-technique/url?annee=${annee}`
)
urlPDF = urlCahierTechnique['url']
```


```{ojs}
viewBlock = html`
  <div style="
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
    align-items: stretch; /* ✅ étire les deux colonnes à la même hauteur */
    width: 100%;
    box-sizing: border-box;
  ">
    <div style="padding: 1rem; border-radius: 8px;">
      ${renderedBlocks}
    </div>
    <div style="
      padding: 1rem; 
      display: flex; 
      flex-direction: column;
    ">
      <iframe 
        src="${urlPDF}#page=${content.data.page}" 
        width="100%" 
        style="flex: 1; border: none;"
      ></iframe>
    </div>
  </div>
`
```

:::


```{ojs}
content = d3.json(`https://specif-dsn.lab.sspcloud.fr/check/${codeDSN}?annee=2025`)
```

```{ojs}
content?.data?.modalites
```

```{ojs}
markdown_modalite = {
  // 1️⃣ On sécurise l’accès à la donnée
  const modalites = (content?.data?.modalites ?? []).sort((a, b) => a[0] - b[0]);

  // 2️⃣ On vérifie que c’est un tableau
  if (!Array.isArray(modalites) || modalites.length === 0) {
    return html`<p style="color:#888;">Aucune modalité disponible.</p>`;
  }

  // 3️⃣ On crée les lignes HTML à partir du tableau
  const rows = modalites.map(
    ([code, label]) => html`<tr><td style="text-align:center;">${code}</td><td>${label}</td></tr>`
  );

  // 4️⃣ On assemble le tout dans un tableau stylé
  const tableHTML = html`
    <table style="border-collapse:collapse; width:100%; margin-top:1em; font-family:sans-serif;">
      <caption style="font-weight:bold; padding:0.5em; caption-side:top; text-align:left;">
        Liste des modalités
      </caption>
      <thead style="background:#444; color:white;">
        <tr>
          <th style="text-align:center; padding:0.5em;">Code</th>
          <th style="text-align:left; padding:0.5em;">Libellé</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>
  `;

  return tableHTML;
}
```


```{ojs}
renderedBlocks = md`
 ### ${content.data.nom_champ} (\`${content.data.code}\`)
 
 **Nom technique** : \`${content.data.nom_technique}\`
  
  ${content.data.description}

  ${markdown_modalite}

  <details>

  <summary>
  Détails supplémentaires de la rubrique
  </summary>

  _${content.data.controles}_

  </details>

  ${copy_button}
`
```

```{ojs}
//import {Copier} from "@mbostock/copier"
pbcopy = text => navigator.clipboard.writeText(text)
function Copier(content = "Copy code", options) {
  if (Array.isArray(content)) content = Array.from(content, ([key, value]) => [key, () => (pbcopy(value), value)]);
  return Inputs.button(content, {...options, reduce: (value) => (pbcopy(value), value)});
}
```


```{ojs}
copy_button = Copier("Copier la sortie en JSON", {value: `${JSON.stringify(content.data, null, 2)}`})
```


